From 0da9fe38247f7fdb8a255242fc5b3e0061834f13 Mon Sep 17 00:00:00 2001
From: Johannes Thoma <johannes@johannesthoma.com>
Date: Mon, 7 Aug 2023 11:36:40 +0000
Subject: [PATCH] Manually patched rcu flags into tr_printk macro.

---
 drbd/drbd-headers/drbd_transport.h | 21 +++++++++++----------
 1 file changed, 11 insertions(+), 10 deletions(-)

diff --git a/drbd/drbd-headers/drbd_transport.h b/drbd/drbd-headers/drbd_transport.h
index 7ba2315..b81b700 100644
--- a/drbd/drbd-headers/drbd_transport.h
+++ b/drbd/drbd-headers/drbd_transport.h
@@ -27,15 +27,17 @@
  */
 #define GFP_TRY	(__GFP_HIGHMEM | __GFP_NOWARN | __GFP_RECLAIM)
 
-#define tr_printk(level, transport, fmt, args...)  {		\
-	rcu_read_lock();					\
-	printk(level "drbd %s %s:%s: " fmt,			\
-	       (transport)->log_prefix,				\
-	       (transport)->class->name,			\
-	       rcu_dereference((transport)->net_conf)->name,	\
-	       ## args);					\
-	rcu_read_unlock();					\
-	}
+
+#define tr_printk(level, transport, fmt, args...)  {                    \
+    KIRQL _tr_printk_rcu_flags;                                         \
+    _tr_printk_rcu_flags = rcu_read_lock();                             \
+    printk(level "drbd %s %s:%s: " fmt,                                 \
+           (transport)->log_prefix,                                     \
+           (transport)->class->name,                                    \
+           rcu_dereference((transport)->net_conf)->name,                \
+	   ## args);                                                    \
+    rcu_read_unlock(_tr_printk_rcu_flags);                              \
+    }
 
 #define tr_err(transport, fmt, args...) \
 	tr_printk(KERN_ERR, transport, fmt, ## args)
@@ -216,7 +218,6 @@ struct drbd_transport_class {
 	struct list_head list;
 };
 
-
 /* An "abstract base class" for transport implementations. I.e. it
    should be embedded into a transport specific representation of a
    listening "socket" */
-- 
2.17.1

