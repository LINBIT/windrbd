diff each C file:
diff -u drbd/drbd/drbd_main.c converted_sources/drbd/drbd_main.c

Add categories:

@@ remove: patch not needed any more
@@ cocci: have generic cocci script to apply this patch (like most spin locks, rcu, unsigned long, ...)
@@ header: add something to a WinDRBD header included here, for example define must_hold to nothing (obsolete, just remove 000_xx perl script)
@@ compat: implement something in the compat layer to resolve this patch
@@ manual: manual patch needed - only if all of the above fail
@@ upstream: this might be interesting for upstream DRBD maybe submit this
@@ review: review this later again

johannes@jt-ubuntu2021B:~/sambashare2/windrbd-squeeze-patches/windrbd/diffs$ grep @@ drbd_main.c.diff | grep -v -- -[0-9] | grep -v cocci | grep -v header | grep -v remove | grep -v page | grep -v upstream | grep -v compat

----

TODO.cocci:	13	6
TODO.compat:	47	45
TODO.manual:	25	16
TODO.upstream:	3	3

----
Patch files must contain tags, as in:

000-rcu-flag.generic.cocci
001-if-then-else-operator.gnuextension.cocci
002-initialize-locking-primitives.drbd.patch
003-two-flags.drbd-gnuextension.cocci

If we are on MSVC enable generic and gnuextension
If we are on gcc just enable generic
Always enable DRBD (except for non-DRBD drivers of course ...)
use - to delimit flags (so that *.gnuextension.patch does not match
but *.drbd-gnuextension.cocci does)

Also 64bit tag (for the ULL tag)

----

Workflow for upgrading DRBD

Have converted sources under git control.

Initially:

Clone drbd repo into converted sources
#git checkout -b drbd-9.0.upstream
Apply cocci patches. (onto cocci branch)
Apply manual patches. (onto manual branch)

Upgrade:

checkout drbd-9.X (upstream)
git pull
apply cocci patches
rebase manual patches
	resolve conflicts manually
rm ../patch-drbd/manual-patches/*
git format-patch cocci .. manual  --suffix .drbd.patch -s -o ../patch-drbd/manual-patches

